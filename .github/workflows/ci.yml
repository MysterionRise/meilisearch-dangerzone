name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run type checking
        run: pnpm type-check

      - name: Run unit tests
        run: pnpm test

      - name: Build Next.js app
        run: pnpm build
        env:
          MEILI_HOST: http://localhost:7700
          MEILI_MASTER_KEY: test-key
          OPENAI_API_KEY: test-key

  integration:
    name: Integration Tests with Meilisearch
    runs-on: ubuntu-latest

    services:
      meilisearch:
        image: getmeili/meilisearch:latest
        env:
          MEILI_MASTER_KEY: test-master-key
          MEILI_ENV: development
        ports:
          - 7700:7700
        options: >-
          --health-cmd "curl -f http://localhost:7700/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for Meilisearch
        run: |
          echo "Waiting for Meilisearch to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:7700/health; then
              echo "Meilisearch is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Verify Meilisearch connection
        run: |
          curl -X GET 'http://localhost:7700/health' \
            -H 'Authorization: Bearer test-master-key'
        env:
          MEILI_HOST: http://localhost:7700
          MEILI_MASTER_KEY: test-master-key

      - name: Run bootstrap script (without embedders)
        run: pnpm bootstrap || echo "Bootstrap completed with warnings (expected without OpenAI key)"
        env:
          MEILI_HOST: http://localhost:7700
          MEILI_MASTER_KEY: test-master-key
        continue-on-error: true

      - name: Verify indexes created
        run: |
          echo "Checking for products index..."
          curl -X GET 'http://localhost:7700/indexes/products' \
            -H 'Authorization: Bearer test-master-key' || echo "Products index check failed"

          echo "Checking for articles index..."
          curl -X GET 'http://localhost:7700/indexes/articles' \
            -H 'Authorization: Bearer test-master-key' || echo "Articles index check failed"
        continue-on-error: true

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        run: |
          echo "Checking code formatting..."
          # Add prettier or eslint here if configured
          echo "No linter configured yet, skipping..."
        continue-on-error: true
